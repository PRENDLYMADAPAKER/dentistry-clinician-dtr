<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Clinician DTR - User Panel</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#a855f7">

<!-- iOS support -->
<link rel="apple-touch-icon" href="https://i.imgur.com/sjdlb28.jpeg">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Clinician DTR">
  
  <style>
  body {
    font-family: Inter, system-ui, Arial, sans-serif;
    background: linear-gradient(135deg, #ffffff, #ff9ce3, #a855f7);
    color: #2c0a34;
    display: flex;
    justify-content: center;
    padding: 28px;
    position: relative;
    overflow-y: auto; /* ‚úÖ scrollable */
    min-height: 100vh;
  }

  body::before {
    content: "";
    position: fixed;
    top: 50%; left: 50%;
    width: 400px; height: 400px;
    background: url('https://i.imgur.com/sjdlb28.jpeg') no-repeat center center;
    background-size: cover;
    opacity: 0.08;
    transform: translate(-50%, -50%);
    z-index: 0;
  }

  .card {
    position: relative; z-index: 1;
    background: rgba(255,255,255,0.2);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    padding: 20px; border-radius: 16px;
    max-width: 600px; width: 100%;
    box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    border: 1px solid rgba(255,255,255,0.3);
    margin-bottom: 16px;
  }

  h1 {
    color: #2c0a34;
    margin: 0 0 12px;
    font-size: 20px;
  }

  input, select {
    width: 100%; box-sizing: border-box;
    padding: 10px; border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.4);
    margin: 8px 0;
    background: rgba(255,255,255,0.2);
    backdrop-filter: blur(8px);
    color: #2c0a34;
  }

  button {
    padding: 10px 14px;
    border-radius: 10px;
    border: none;
    background: linear-gradient(135deg, #ffffff, #ff9ce3, #a855f7);
    color: #2c0a34;
    font-weight: 600;
    cursor: pointer;
    transition: 0.3s ease;
  }
  button:hover { opacity: 0.9; transform: scale(1.03); }

  .linkbtn {
    background: transparent;
    border: none;
    text-decoration: underline;
    cursor: pointer;
    color: #2c0a34;
  }

  .muted { font-size: 13px; opacity: 0.8; }
  .error { color: #b91c1c; }
  .success { color: #166534; }

  #qr {
    width: 180px; height: 180px;
    background: rgba(255,255,255,0.3);
    backdrop-filter: blur(8px);
    border-radius: 12px; padding: 8px;
    margin: 12px auto;
    display:flex; align-items:center; justify-content:center;
  }

  table { width:100%; border-collapse:collapse; margin-top:12px; }
  th, td { padding:8px; border-bottom:1px solid rgba(255,255,255,0.3); font-size:13px; text-align:left; }

  .toggle-btns { display:flex; gap:10px; margin:14px 0; flex-wrap:wrap; }
  .toggle-btns button.active { background:#2c0a34; color:white; }

  .modal {
    position:fixed; top:0; left:0;
    width:100%; height:100%;
    background:rgba(0,0,0,0.5);
    display:none; justify-content:center; align-items:center;
    z-index:200;
  }
  .modal-content {
    background:rgba(255,255,255,0.95);
    padding:20px;
    border-radius:12px;
    max-width:500px; width:90%;
    color:#2c0a34;
    overflow-y:auto;
    max-height:90vh;
  }
  .modal h2 { margin-top:0; }
  .closeBtn {
    float:right;
    background:#ef4444; color:white;
    border:none; padding:6px 10px;
    border-radius:6px; cursor:pointer;
  }

  .tab-buttons { display:flex; gap:6px; margin:10px 0; flex-wrap:wrap; }
  .tab-buttons button { flex:1; font-size:14px; }
  .tab-buttons button.active { background:#2c0a34; color:white; }

  .tab-section { display:none; }
  .tab-section.active { display:block; }

  .search-box { margin:10px 0; }
  .status-badge { font-weight:bold; padding:2px 6px; border-radius:6px; }
  .completed { color:green; }
  .pending { color:orange; }
  </style>
</head>
<body>
  <!-- === LOGIN === -->
  <div class="card" id="authArea">
    <h1>Login</h1>
    <input type="email" id="email" placeholder="Email" />
    <input type="password" id="password" placeholder="Password" />
    <button onclick="login()">Login</button>
    <p class="muted">Don‚Äôt have an account?
      <button class="linkbtn" onclick="toggleAuth('register')">Create one</button>
    </p>
    <p><button class="linkbtn" onclick="showForgotPassword()">Forgot Password?</button></p>
    <p id="authMsg" class="muted"></p>
  </div>

  <!-- === FORGOT PASSWORD === -->
  <div class="card" id="forgotArea" style="display:none">
    <h1>Reset Password</h1>
    <input type="email" id="resetEmail" placeholder="Enter your registered email" />
    <button onclick="resetPassword()">Send Reset Link</button>
    <p class="muted"><button class="linkbtn" onclick="toggleAuth('login')">Back to Login</button></p>
    <p id="resetMsg" class="muted"></p>
  </div>

  <!-- === REGISTER === -->
  <div class="card" id="registerArea" style="display:none">
    <h1>Create Account</h1>
    <input type="text" id="regName" placeholder="Full Name" />
    <input type="email" id="regEmail" placeholder="Email" />
    <input type="password" id="regPassword" placeholder="Password" />
    <input type="text" id="regLevel" placeholder="Clinical Level" />
    <button onclick="register()">Register</button>
    <p class="muted">Already have an account?
      <button class="linkbtn" onclick="toggleAuth('login')">Login</button>
    </p>
    <p id="regMsg" class="muted"></p>
  </div>
  <!-- === USER PANEL === -->
<div class="card" id="userPanel" style="display:none">
  <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px;">
  <h1>DMD CLINICIAN DTR</h1>

  <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end;">
    
    <!-- ‚öôÔ∏è UPDATE INFO -->
    <button id="settingsBtn" style="padding:6px 10px;font-size:13px;">
      ‚öôÔ∏è Update Info
    </button>

    <!-- üïí WAITING LIST -->
    <button id="waitingBtn" style="padding:6px 10px;font-size:13px;position:relative;">
      üïí Waiting List
      <span id="waitingBadge"
        style="display:none;position:absolute;top:-6px;right:-6px;background:#ef4444;color:#fff;border-radius:999px;padding:2px 6px;font-size:11px;">
        0
      </span>
    </button>

  </div>
</div>

    <div class="muted">Signed in as</div>
    <div id="nameDisplay" style="font-weight:600"></div>
    <div id="emailDisplay" class="muted"></div>
    <div id="levelDisplay" class="muted"></div>

    <div id="qr"></div>
    <button id="logoutBtn" style="background:#ef4444;color:white;">Logout</button>

    <div class="toggle-btns">
      <button id="dtrBtn" class="active">My DTR Records</button>
      <button id="caseBtn">My Case Selections</button>
    </div>

    <div id="dtrSection">
      <h3>My DTR Records</h3>
      <table>
        <thead><tr><th>Date</th><th>Time In</th></tr></thead>
        <tbody id="myDtrBody"><tr><td colspan="2" class="muted">No records</td></tr></tbody>
      </table>
    </div>

    <div id="caseSection" style="display:none">
      <h3>My Case Selections</h3>
      <input type="text" id="caseSearch" class="search-box" placeholder="Search cases..." />
      <button id="openCaseModal" style="margin:6px 0" disabled title="Please Time In first">‚ûï New Case Selection</button>
      <table>
        <thead><tr><th>Type</th><th>Details</th><th>Date</th><th>Status</th><th>Action</th></tr></thead>
        <tbody id="caseBody"><tr><td colspan="5" class="muted">No cases</td></tr></tbody>
      </table>
    </div>
    </div>
  </div>

  <!-- === SETTINGS MODAL === -->
  <div id="settingsModal" class="modal">
    <div class="modal-content">
      <button id="closeModal" class="closeBtn">‚úñ</button>
      <h2>Request Update</h2>
      <label>Field:
        <select id="fieldSelect">
          <option value="name">Name</option>
          <option value="email">Email</option>
          <option value="password">Password</option>
          <option value="clinicalLevel">Clinical Level</option>
        </select>
      </label>
      <br><br>
      <input type="text" id="newValue" placeholder="Enter new value" />
      <button onclick="submitUpdate()">Submit Request</button>
      <p id="updateStatus" class="muted"></p>
    </div>
  </div>

  <!-- === CASE MODAL === -->
  <div id="caseModal" class="modal">
    <div class="modal-content">
      <button id="closeCaseModal" class="closeBtn">‚úñ</button>
      <h2>Case Selection</h2>

      <div class="tab-buttons">
        <button class="tabBtn active" data-tab="livePatient">Live Patient</button>
        <button class="tabBtn" data-tab="typodonts">Typodonts</button>
        <button class="tabBtn" data-tab="cast">CAST</button>
      </div>

      <!-- Live Patient -->
      <div id="livePatient" class="tab-section active">
        <label>Clinician Name</label>
        <input type="text" id="lpClinician" disabled />
        <label>Patient Name</label>
        <input type="text" id="lpPatient" />
        <label>Case Procedure</label>
        <input type="text" id="lpProcedure" />
        <label>Mastercard No. (optional)</label>
        <input type="text" id="lpMaster" />
        <label>Clinical Instructor</label>
        <input type="text" value="Pending (Assigned by Admin)" disabled />
      </div>

      <!-- Typodonts -->
      <div id="typodonts" class="tab-section">
        <label>Case Type</label>
        <select id="typoCaseType">
          <option value="">-- Select --</option>
          <option value="pfm">PFM/FPD</option>
          <option value="restorative">Restorative</option>
        </select>

        <div id="pfmFields" style="display:none; margin-top:10px;">
          <label>PFM/FPD</label>
          <select id="typoPfm">
            <option value="">-- Select --</option>
            <option>Anterior</option>
            <option>Posterior</option>
          </select>
          <label>Mastercard No. (optional)</label>
          <input type="text" id="typoMasterPfm" />
          <label>Clinical Instructor</label>
          <input type="text" value="Pending (Assigned by Admin)" disabled />
        </div>

        <div id="restFields" style="display:none; margin-top:10px;">
          <label>Restorative (type manually)</label>
          <input type="text" id="typoRest" />
          <label>Mastercard No. (optional)</label>
          <input type="text" id="typoMasterRest" />
          <label>Clinical Instructor</label>
          <input type="text" value="Pending (Assigned by Admin)" disabled />
        </div>
      </div>

      <!-- CAST -->
      <div id="cast" class="tab-section">
        <label>RPD or CD</label>
        <select id="castType">
          <option value="">-- Select --</option>
          <option>RPD</option>
          <option>CD</option>
        </select>
        <label>Mastercard No. (optional)</label>
        <input type="text" id="castMaster" />
        <label>Clinical Instructor</label>
        <input type="text" value="Pending (Assigned by Admin)" disabled />
      </div>

      <br>
      <button onclick="submitCase()">Submit Case</button>
      <p id="caseStatus" class="muted"></p>
    </div>
  </div>
  
       <!-- === WAITING LIST MODAL === -->
<div id="waitingModal" class="modal">
  <div class="modal-content">
    <button id="closeWaitingModal" class="closeBtn">‚úñ</button>
    <h2>Waiting List (Today)</h2>
    <p class="muted" id="myQueuePos">Checking your position...</p>

    <table>
      <thead><tr><th>#</th><th>Name</th><th>Added</th></tr></thead>
      <tbody id="waitingListBody">
        <tr><td colspan="3" class="muted">No students in waiting list</td></tr>
      </tbody>
    </table>
  </div>
</div>

  <!-- === SCRIPTS === -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-database-compat.js"></script>

  <script>
  const firebaseConfig = {
    apiKey: "AIzaSyBYYZrsZECXM2UpW4-38sGQLaPqAqkjSWI",
    authDomain: "dtr-project-66048.firebaseapp.com",
    databaseURL: "https://dtr-project-66048-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "dtr-project-66048",
    storageBucket: "dtr-project-66048.appspot.com",
    messagingSenderId: "271445506225",
    appId: "1:271445506225:web:fcb04d0454e1302de14a90"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  // === DAILY WAITING LIST ===
// PH time helpers (UTC+8)
function getPHDate(now = new Date()){
  const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
  return new Date(utc + (3600000 * 8));
}

function todayKey(now = new Date()) {
  const ph = getPHDate(now);
  const y = ph.getFullYear();
  const m = String(ph.getMonth() + 1).padStart(2, '0');
  const d = String(ph.getDate()).padStart(2, '0');
  return `${y}-${m}-${d}`;
}

// ‚úÖ IMPORTANT: daily node
function waitingRef() {
  return db.ref(`waitingList/${todayKey()}`);
}

function setupWaitingModalUI() {
  const modal = document.getElementById('waitingModal');
  document.getElementById('waitingBtn').onclick = () => modal.style.display = 'flex';
  document.getElementById('closeWaitingModal').onclick = () => modal.style.display = 'none';

  window.addEventListener('click', e => {
    if (e.target === modal) modal.style.display = 'none';
  });
}

function startWaitingWatcher(uid) {
  const badge = document.getElementById('waitingBadge');
  const tbody = document.getElementById('waitingListBody');
  const pos = document.getElementById('myQueuePos');

  waitingRef().on('value', snap => {
  const items = [];

  if (snap.exists()) {
    snap.forEach(ch => {
      items.push({
        key: ch.key,
        ...ch.val()
      });
    });
  }

  items.sort((a, b) => (a.ts || 0) - (b.ts || 0));

  badge.textContent = items.length;
  badge.style.display = items.length ? 'inline-block' : 'none';

  tbody.innerHTML = items.length
    ? ""
    : `<tr><td colspan="3" class="muted">No students in waiting list</td></tr>`;

  items.forEach((it, i) => {
    const isMe = it.uid === uid;
    tbody.innerHTML += `
      <tr style="${isMe ? 'font-weight:bold;background:#f0f9ff;' : ''}">
        <td>${i + 1}${isMe ? ' ‚≠ê' : ''}</td>
        <td>${it.name || '-'}</td>
        <td>${it.ts ? new Date(it.ts).toLocaleString() : '-'}</td>
      </tr>`;
  });

  const myIndex = items.findIndex(x => x.uid === uid);
  pos.textContent = myIndex >= 0
    ? `‚úÖ Your queue number is #${myIndex + 1}`
    : `‚ÑπÔ∏è You are not in today's waiting list.`;
});
}

  // === UI TOGGLES ===
  function toggleAuth(mode) {
    document.getElementById("authArea").style.display = (mode === "register") ? "none" : "block";
    document.getElementById("registerArea").style.display = (mode === "register") ? "block" : "none";
    document.getElementById("forgotArea").style.display = "none";
  }
  function showForgotPassword() {
    document.getElementById("authArea").style.display = "none";
    document.getElementById("registerArea").style.display = "none";
    document.getElementById("forgotArea").style.display = "block";
  }

  // === FORGOT PASSWORD ===
  async function resetPassword() {
    const email = document.getElementById('resetEmail').value.trim();
    const msg = document.getElementById('resetMsg');
    if (!email) { msg.textContent = "Please enter your email."; msg.className = "error"; return; }
    try {
      await auth.sendPasswordResetEmail(email);
      msg.textContent = "‚úÖ Password reset link sent! Check your inbox.";
      msg.className = "success";
    } catch (e) {
      msg.textContent = e.message;
      msg.className = "error";
    }
  }

  // === LOGIN / REGISTER ===
  async function login() {
    const email = document.getElementById('email').value;
    const pass = document.getElementById('password').value;
    const msg = document.getElementById('authMsg');
    try { await auth.signInWithEmailAndPassword(email, pass); }
    catch (e) { msg.textContent = e.message; msg.className = "error"; }
  }

  async function register() {
    const name = document.getElementById('regName').value.trim();
    const email = document.getElementById('regEmail').value.trim();
    const pass = document.getElementById('regPassword').value;
    const level = document.getElementById('regLevel').value.trim();
    const msg = document.getElementById('regMsg');
    try {
      const cred = await auth.createUserWithEmailAndPassword(email, pass);
      const uid = cred.user.uid;
      await db.ref('users/' + uid + '/profile').set({ name, email, clinicalLevel: level });
      msg.textContent = "Account created! Redirecting...";
      msg.className = "success";
      await auth.signInWithEmailAndPassword(email, pass);
    } catch (e) {
      msg.textContent = e.message; msg.className = "error";
    }
  }

  document.getElementById('logoutBtn').onclick = () => auth.signOut();

  // === LOAD DTR & CASES ===
  // ‚úÖ REAL-TIME User DTR Loader
let userDtrListener = null;

function loadUserDTR(uid) {
  const tbody = document.getElementById('myDtrBody');
  if (!tbody) return;

  // Remove old listener (prevents duplicates)
  if (userDtrListener) {
    db.ref('users/' + uid + '/dtr').off('value', userDtrListener);
  }

  // Live listener
  userDtrListener = (snap) => {
    tbody.innerHTML = "";

    if (!snap.exists()) {
      tbody.innerHTML = "<tr><td colspan='2' class='muted'>No records</td></tr>";
      return;
    }

    const rows = [];
    snap.forEach(child => {
      const date = child.key;
      const rec = child.val() || {};
      rows.push({
        date,
        timeIn: rec.timeIn || '-',
        ts: rec.ts || 0
      });
    });

    // Sort newest first (optional)
    rows.sort((a, b) => (b.ts || 0) - (a.ts || 0));

    tbody.innerHTML = rows.map(r =>
      `<tr><td>${r.date}</td><td>${r.timeIn}</td></tr>`
    ).join("");
  };

  db.ref('users/' + uid + '/dtr').on('value', userDtrListener);
}

  async function loadUserCases(uid) {
  const tbody = document.getElementById('caseBody');
  tbody.innerHTML = "<tr><td colspan='5' class='muted'>Loading cases...</td></tr>";

  // Remove any existing listener before adding a new one (prevents duplicates)
  if (window.userCasesListener) {
    db.ref('userCases/' + uid).off('value', window.userCasesListener);
  }

  // Define a listener function
  window.userCasesListener = db.ref('userCases/' + uid).on('value', snap => {
    tbody.innerHTML = "";
    const seen = new Set();

    if (!snap.exists()) {
      tbody.innerHTML = "<tr><td colspan='5' class='muted'>No cases</td></tr>";
      return;
    }

    snap.forEach(child => {
      const cid = child.key;
      if (seen.has(cid)) return;
      seen.add(cid);

      const c = child.val() || {};
      const date = c.timestamp ? new Date(c.timestamp).toLocaleString() : "-";
      const status = c.status === "completed"
        ? `<span class='status-badge completed'>‚úÖ Completed</span>`
        : `<span class='status-badge pending'>Pending</span>`;
      const action = c.status === "completed"
        ? "‚Äî"
        : `<button onclick="markCaseComplete('${uid}','${cid}', event)">Mark Completed</button>`;

      tbody.innerHTML += `
        <tr id="case-${cid}">
          <td>${c.type || "-"}</td>
          <td>${c.details || ""}<br><span class='muted'>Instructor: ${c.instructor || "Pending"}</span></td>
          <td>${date}</td>
          <td>${status}</td>
          <td>${action}</td>
        </tr>`;
    });

    applyCaseSearch();
  });
  }

  function applyCaseSearch() {
    const input = document.getElementById('caseSearch').value.toLowerCase();
    const rows = document.querySelectorAll("#caseBody tr");
    rows.forEach(row => {
      const text = row.innerText.toLowerCase();
      row.style.display = text.includes(input) ? "" : "none";
    });
  }
  document.getElementById('caseSearch').addEventListener('input', applyCaseSearch);

    // ===== MARK CASE AS COMPLETED (User side only) =====
let markInProgress = false;

async function markCaseComplete(uid, cid, event) {
  if (markInProgress) return;
  markInProgress = true;

  try {
    const btn = event?.target;
    if (btn) {
      btn.disabled = true;
      btn.innerText = "‚è≥ Processing...";
    }

    // ‚úÖ Only update the user's own copy
    const caseRef = db.ref(`userCases/${uid}/${cid}`);
    const caseSnap = await caseRef.get();

    if (!caseSnap.exists()) {
      showToast("‚ö†Ô∏è Case not found on user side", "warning");
      return;
    }

    const caseData = caseSnap.val();

    // ‚úÖ Update status only in user's node, not admin's
    await caseRef.update({
      status: "completed",
      completedAt: Date.now()
    });

    // üö´ Do NOT touch admin nodes like `cases/` or `doneAssign/`
    showToast("‚úÖ Case marked as completed (user only)", "success");

  } catch (e) {
    console.error("Mark complete error:", e);
    showToast("‚ùå Failed to mark complete", "error");
  } finally {
    const btn = event?.target;
    if (btn) {
      btn.disabled = false;
      btn.innerText = "Mark Completed";
    }
    markInProgress = false;
  }
}
  
  // === AUTH STATE LISTENER ===
auth.onAuthStateChanged(async user => {
  if (user) {
    document.getElementById('authArea').style.display = 'none';
    document.getElementById('registerArea').style.display = 'none';
    document.getElementById('forgotArea').style.display = 'none';
    document.getElementById('userPanel').style.display = 'block';

    const profileSnap = await db.ref('users/' + user.uid + '/profile').get();
    const profile = profileSnap.exists() ? profileSnap.val() : {};
    document.getElementById('nameDisplay').textContent = profile.name || user.email;
    document.getElementById('emailDisplay').textContent = profile.email || '';
    document.getElementById('levelDisplay').textContent = profile.clinicalLevel ? `Clinical Level: ${profile.clinicalLevel}` : '';
    document.getElementById('lpClinician').value = profile.name || user.email;

    const qrDiv = document.getElementById('qr');
    qrDiv.innerHTML = "";
    new QRCode(qrDiv, { text: user.uid, width: 160, height: 160 });

    const today = todayKey();
    const caseBtn = document.getElementById('openCaseModal');
    // Prevent stacking listeners
if (window.caseUnlockListener) {
  db.ref('users/' + user.uid + '/dtr/' + today)
    .off('value', window.caseUnlockListener);
}

// Create listener
window.caseUnlockListener = (snap) => {
  if (snap.exists() && snap.val().timeIn) {
    caseBtn.disabled = false;
    caseBtn.style.opacity = "1";
    caseBtn.style.cursor = "pointer";
    caseBtn.title = "Add a new case";
  } else {
    caseBtn.disabled = true;
    caseBtn.style.opacity = "0.5";
    caseBtn.style.cursor = "not-allowed";
    caseBtn.title = "Please Time In first";
  }
};

// Attach listener
db.ref('users/' + user.uid + '/dtr/' + today)
  .on('value', window.caseUnlockListener);

    // ‚úÖ Load user data
    loadUserDTR(user.uid);
    loadUserCases(user.uid);
    setupWaitingModalUI();
    startWaitingWatcher(user.uid);

  } else {
    document.getElementById('authArea').style.display = 'block';
    document.getElementById('registerArea').style.display = 'none';
    document.getElementById('forgotArea').style.display = 'none';
    document.getElementById('userPanel').style.display = 'none';
  }
});

  // === SETTINGS & CASE MODALS ===
  const settingsModal = document.getElementById('settingsModal');
  document.getElementById('settingsBtn').onclick = () => settingsModal.style.display = 'flex';
  document.getElementById('closeModal').onclick = () => settingsModal.style.display = 'none';
  const caseModal = document.getElementById('caseModal');
  document.getElementById('openCaseModal').onclick = () => caseModal.style.display = 'flex';
  document.getElementById('closeCaseModal').onclick = () => caseModal.style.display = 'none';
  window.onclick = e => {
    if (e.target === settingsModal) settingsModal.style.display = 'none';
    if (e.target === caseModal) caseModal.style.display = 'none';
  };

  async function submitUpdate() {
    const field = document.getElementById('fieldSelect').value;
    const value = document.getElementById('newValue').value.trim();
    const status = document.getElementById('updateStatus');
    const user = auth.currentUser;
    if (!user) return;
    if (!value) { status.textContent = "Please enter a value."; status.className = "error"; return; }
    const reqRef = db.ref('updateRequests/' + user.uid).push();
    await reqRef.set({ field, value, status: "pending", timestamp: Date.now() });
    status.textContent = "Request submitted."; status.className = "success";
    document.getElementById('newValue').value = "";
  }

  // === CASE TAB LOGIC ===
  document.querySelectorAll('.tabBtn').forEach(btn => {
    btn.onclick = () => {
      document.querySelectorAll('.tabBtn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      document.querySelectorAll('.tab-section').forEach(sec => sec.classList.remove('active'));
      document.getElementById(btn.dataset.tab).classList.add('active');
    };
  });

  const typoCaseType = document.getElementById('typoCaseType');
  const pfmFields = document.getElementById('pfmFields');
  const restFields = document.getElementById('restFields');
  typoCaseType.onchange = () => {
    if (typoCaseType.value === "pfm") { pfmFields.style.display = "block"; restFields.style.display = "none"; }
    else if (typoCaseType.value === "restorative") { restFields.style.display = "block"; pfmFields.style.display = "none"; }
    else { pfmFields.style.display = "none"; restFields.style.display = "none"; }
  };

  async function submitCase() {
  const user = auth.currentUser;
  if (!user) return;

  const status = document.getElementById('caseStatus');
  let caseData = {
    type: "",
    details: "",
    instructor: "Pending",
    timestamp: Date.now(),
    status: "pending"
  };

  const activeTab = document.querySelector('.tabBtn.active').dataset.tab;

  if (activeTab === "livePatient") {
    caseData.type = "Live Patient";
    caseData.details = `Patient: ${document.getElementById('lpPatient').value}, Procedure: ${document.getElementById('lpProcedure').value}, Mastercard: ${document.getElementById('lpMaster').value || "N/A"}`;
  } 
  else if (activeTab === "typodonts") {
    caseData.type = "Typodonts";
    if (typoCaseType.value === "pfm") {
      caseData.details = `PFM/FPD: ${document.getElementById('typoPfm').value || "N/A"}, Mastercard: ${document.getElementById('typoMasterPfm').value || "N/A"}`;
    } else if (typoCaseType.value === "restorative") {
      caseData.details = `Restorative: ${document.getElementById('typoRest').value || "N/A"}, Mastercard: ${document.getElementById('typoMasterRest').value || "N/A"}`;
    } else {
      status.textContent = "Please select Typodonts case type.";
      status.className = "error";
      return;
    }
  } 
  else if (activeTab === "cast") {
    caseData.type = "CAST";
    caseData.details = `Type: ${document.getElementById('castType').value || "N/A"}, Mastercard: ${document.getElementById('castMaster').value || "N/A"}`;
  }

  // ‚úÖ Generate unique ID for the case
  const caseRef = db.ref('cases/' + user.uid).push();
  const caseId = caseRef.key;

  // ‚úÖ Save to Admin Panel
  await caseRef.set(caseData);

  // ‚úÖ Also save to User Panel
  await db.ref(`userCases/${user.uid}/${caseId}`).set(caseData);

  // ‚úÖ UI feedback
  status.textContent = "Case submitted successfully!";
  status.className = "success";

  // ‚úÖ Reload and close modal
  await loadUserCases(user.uid);
  setTimeout(() => {
    caseModal.style.display = 'none';
    status.textContent = "";
  }, 1000);
    }

  // === SECTION TOGGLES ===
  const dtrBtn = document.getElementById('dtrBtn');
  const caseBtn = document.getElementById('caseBtn');
  dtrBtn.onclick = () => {
    dtrBtn.classList.add('active');
    caseBtn.classList.remove('active');
    document.getElementById('dtrSection').style.display = 'block';
    document.getElementById('caseSection').style.display = 'none';
  };
  caseBtn.onclick = () => {
    caseBtn.classList.add('active');
    dtrBtn.classList.remove('active');
    document.getElementById('caseSection').style.display = 'block';
    document.getElementById('dtrSection').style.display = 'none';
  };
  </script>

<style>
  body {
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
    margin: 0;
  }

  footer.page-footer {
    text-align: center;
    width: 100%;
    padding: 10px 0;
    font-family: 'Poppins', Arial, sans-serif;
    font-size: 13px;
    color: #5a437c;
    opacity: 0.85;
    margin-top: auto;
  }

  .page-footer .official {
    display: block;
    font-size: 14px;
    font-weight: 800;
    color: #2c0a34;
    opacity: 1;
    margin-bottom: 2px;
  }

  .page-footer .authorized {
    display: block;
    font-size: 12px;
    font-weight: 600;
    color: #2c0a34;
    opacity: 1;
    margin-bottom: 10px;
  }
</style>

<footer class="page-footer">
  Created by <strong>NZM</strong><br>
  &copy; 2025 | To God Be the Glory
</footer>

  <script>
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("./service-worker.js")
      .then(() => console.log("‚úÖ Service Worker Registered"))
      .catch(err => console.error("SW registration failed:", err));
  });
}
  </script>

</body>
</html>
